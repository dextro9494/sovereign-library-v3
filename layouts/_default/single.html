{{ define "main" }}
<article class="card">
  <h1>{{ .Title }}</h1>

  {{ if .Params.tags }}
  <div class="tags">
    {{ range .Params.tags }}
      <span class="tag">{{ . }}</span>
    {{ end }}
  </div>
  {{ end }}

  {{ if .Date }}
  <p class="meta">{{ .Date.Format "2006-01-02" }}</p>
  {{ end }}

  <div class="content">
    {{ .Content }}
  </div>

  {{ if .Params.connected }}
  <div class="connections">
    <h3>Connected to</h3>
    <ul>
      {{ range .Params.connected }}
        {{ $path := . }}
        {{ $clean := strings.TrimSuffix "/" $path }}
        {{ $p := site.GetPage $clean }}
        {{ if $p }}
          <li><a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a></li>
        {{ else }}
          <li><span class="missing">Missing:</span> <code>{{ $path }}</code></li>
        {{ end }}
      {{ end }}
    </ul>
  </div>
  {{ end }}

  {{/* Backlinks: pages that include THIS page in their `connected:` list */}}
  {{ $self := strings.TrimSuffix "/" .RelPermalink }}
  {{ $scratch := newScratch }}

  {{ range site.RegularPages }}
    {{ $src := . }}
    {{ if $src.Params.connected }}
      {{ range $src.Params.connected }}
        {{ $candidate := strings.TrimSuffix "/" . }}
        {{ if eq $candidate $self }}
          {{ $scratch.Add "backlinks" (slice $src) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $backlinks := $scratch.Get "backlinks" }}
  {{ if $backlinks }}
  <div class="connections">
    <h3>Referenced by</h3>
    <ul>
      {{ range sort $backlinks "Title" "asc" }}
        <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
      {{ end }}
    </ul>
  </div>
  {{ end }}

</article>
{{ end }}
